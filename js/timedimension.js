L.TimeDimension=(L.Layer||L.Class).extend({includes:L.Mixin.Events,initialize:function(i){L.setOptions(this,i);this._availableTimes=this._generateAvailableTimes();this._currentTimeIndex=-1;this._loadingTimeIndex=-1;this._loadingTimeout=this.options.loadingTimeout||3e3;this._syncedLayers=[];if(this._availableTimes.length>0){this.setCurrentTime(this.options.currentTime||this._getDefaultCurrentTime())}if(this.options.lowerLimitTime){this.setLowerLimit(this.options.lowerLimitTime)}if(this.options.upperLimitTime){this.setUpperLimit(this.options.upperLimitTime)}},getAvailableTimes:function(){return this._availableTimes},getCurrentTimeIndex:function(){if(this._currentTimeIndex===-1){return this._availableTimes.length-1}return this._currentTimeIndex},getCurrentTime:function(){var i=-1;if(this._loadingTimeIndex!==-1){i=this._loadingTimeIndex}else{i=this.getCurrentTimeIndex()}if(i>=0){return this._availableTimes[i]}else{return null}},isLoading:function(){return this._loadingTimeIndex!==-1},setCurrentTimeIndex:function(i){var e=this._upperLimit||this._availableTimes.length-1;var t=this._lowerLimit||0;i=Math.min(Math.max(t,i),e);if(i<0){return}this._loadingTimeIndex=i;var s=this._availableTimes[i];console.log("INIT -- Current time: "+new Date(s).toISOString());if(this._checkSyncedLayersReady(this._availableTimes[this._loadingTimeIndex])){this._newTimeIndexLoaded()}else{this.fire("timeloading",{time:s});setTimeout(function(i){if(i==this._loadingTimeIndex){console.log("Change time for timeout");this._newTimeIndexLoaded()}}.bind(this,i),this._loadingTimeout)}},_newTimeIndexLoaded:function(){if(this._loadingTimeIndex===-1){return}var i=this._availableTimes[this._loadingTimeIndex];console.log("END -- Current time: "+new Date(i).toISOString());this._currentTimeIndex=this._loadingTimeIndex;this.fire("timeload",{time:i});this._loadingTimeIndex=-1},_checkSyncedLayersReady:function(i){for(var e=0,t=this._syncedLayers.length;e<t;e++){if(this._syncedLayers[e].isReady){if(!this._syncedLayers[e].isReady(i)){return false}}}return true},setCurrentTime:function(i){var e=this._seekNearestTimeIndex(i);this.setCurrentTimeIndex(e)},seekNearestTime:function(i){var e=this._seekNearestTimeIndex(i);return this._availableTimes[e]},nextTime:function(i,e){if(!i){i=1}var t=this._currentTimeIndex;var s=this._upperLimit||this._availableTimes.length-1;var n=this._lowerLimit||0;if(this._loadingTimeIndex>-1){t=this._loadingTimeIndex}t=t+i;if(t>s){if(!!e){t=n}else{t=s}}if(t<n){if(!!e){t=s}else{t=n}}this.setCurrentTimeIndex(t)},prepareNextTimes:function(i,e,t){if(!i){i=1}var s=this._currentTimeIndex;var n=s;if(this._loadingTimeIndex>-1){s=this._loadingTimeIndex}for(var a=0,o=this._syncedLayers.length;a<o;a++){if(this._syncedLayers[a].setMinimumForwardCache){this._syncedLayers[a].setMinimumForwardCache(e)}}var r=e;var l=this._upperLimit||this._availableTimes.length-1;var h=this._lowerLimit||0;while(r>0){s=s+i;if(s>l){if(!!t){s=h}else{break}}if(s<h){if(!!t){s=l}else{break}}if(n===s){break}this.fire("timeloading",{time:this._availableTimes[s]});r--}},getNumberNextTimesReady:function(i,e,t){if(!i){i=1}var s=this._currentTimeIndex;if(this._loadingTimeIndex>-1){s=this._loadingTimeIndex}var n=e;var a=0;var o=this._upperLimit||this._availableTimes.length-1;var r=this._lowerLimit||0;while(n>0){s=s+i;if(s>o){if(!!t){s=r}else{n=0;a=e;break}}if(s<r){if(!!t){s=o}else{n=0;a=e;break}}var l=this._availableTimes[s];if(this._checkSyncedLayersReady(l)){a++}n--}return a},previousTime:function(i,e){this.nextTime(i*-1,e)},registerSyncedLayer:function(i){this._syncedLayers.push(i);i.on("timeload",this._onSyncedLayerLoaded,this)},unregisterSyncedLayer:function(i){var e=this._syncedLayers.indexOf(i);if(e!=-1){this._syncedLayers.splice(e,1)}i.off("timeload",this._onSyncedLayerLoaded,this)},_onSyncedLayerLoaded:function(i){if(i.time==this._availableTimes[this._loadingTimeIndex]&&this._checkSyncedLayersReady(i.time)){this._newTimeIndexLoaded()}},_generateAvailableTimes:function(){if(this.options.times){return L.TimeDimension.Util.parseTimesExpression(this.options.times)}else if(this.options.timeInterval){var i=L.TimeDimension.Util.parseTimeInterval(this.options.timeInterval);var e=this.options.period||"P1D";var t=this.options.validTimeRange||undefined;return L.TimeDimension.Util.explodeTimeRange(i[0],i[1],e,t)}else{return[]}},_getDefaultCurrentTime:function(){var i=this._seekNearestTimeIndex((new Date).getTime());return this._availableTimes[i]},_seekNearestTimeIndex:function(i){var e=0;var t=this._availableTimes.length;for(;e<t;e++){if(i<this._availableTimes[e]){break}}if(e>0){e--}return e},setAvailableTimes:function(i,e){var t=this.getCurrentTime(),s=this.getLowerLimit(),n=this.getUpperLimit();if(e=="extremes"){var a=this.options.period||"P1D";this._availableTimes=L.TimeDimension.Util.explodeTimeRange(new Date(i[0]),new Date(i[i.length-1]),a)}else{var o=L.TimeDimension.Util.parseTimesExpression(i);if(this._availableTimes.length===0){this._availableTimes=o}else if(e=="intersect"){this._availableTimes=L.TimeDimension.Util.intersect_arrays(o,this._availableTimes)}else if(e=="union"){this._availableTimes=L.TimeDimension.Util.union_arrays(o,this._availableTimes)}else if(e=="replace"){this._availableTimes=o}else{throw"Merge available times mode not implemented: "+e}}if(s){this.setLowerLimit(s)}if(n){this.setUpperLimit(n)}this.setCurrentTime(t);this.fire("availabletimeschanged",{availableTimes:this._availableTimes,currentTime:t});console.log("available times changed")},getLowerLimit:function(){return this._availableTimes[this.getLowerLimitIndex()]},getUpperLimit:function(){return this._availableTimes[this.getUpperLimitIndex()]},setLowerLimit:function(i){var e=this._seekNearestTimeIndex(i);this.setLowerLimitIndex(e)},setUpperLimit:function(i){var e=this._seekNearestTimeIndex(i);this.setUpperLimitIndex(e)},setLowerLimitIndex:function(i){this._lowerLimit=Math.min(Math.max(i||0,0),this._upperLimit||this._availableTimes.length-1);this.fire("limitschanged",{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},setUpperLimitIndex:function(i){this._upperLimit=Math.max(Math.min(i,this._availableTimes.length-1),this._lowerLimit||0);this.fire("limitschanged",{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},getLowerLimitIndex:function(){return this._lowerLimit},getUpperLimitIndex:function(){return this._upperLimit}});L.Map.addInitHook(function(){if(this.options.timeDimension){this.timeDimension=L.timeDimension(this.options.timeDimensionOptions||{})}});L.timeDimension=function(i){return new L.TimeDimension(i)};L.TimeDimension.Layer=(L.Layer||L.Class).extend({includes:L.Mixin.Events,options:{opacity:1,zIndex:1},initialize:function(i,e){L.setOptions(this,e||{});this._map=null;this._baseLayer=i;this._currentLayer=null;this._timeDimension=this.options.timeDimension||null},addTo:function(i){i.addLayer(this);return this},onAdd:function(i){this._map=i;if(!this._timeDimension&&i.timeDimension){this._timeDimension=i.timeDimension}this._timeDimension.on("timeloading",this._onNewTimeLoading,this);this._timeDimension.on("timeload",this._update,this);this._timeDimension.registerSyncedLayer(this);this._update()},onRemove:function(i){this._timeDimension.unregisterSyncedLayer(this);this._timeDimension.off("timeloading",this._onNewTimeLoading,this);this._timeDimension.off("timeload",this._update,this);this.eachLayer(i.removeLayer,i);this._map=null},eachLayer:function(i,e){i.call(e,this._baseLayer);return this},setZIndex:function(i){this.options.zIndex=i;if(this._baseLayer.setZIndex){this._baseLayer.setZIndex(i)}if(this._currentLayer&&this._currentLayer.setZIndex){this._currentLayer.setZIndex(i)}return this},setOpacity:function(i){this.options.opacity=i;if(this._baseLayer.setOpacity){this._baseLayer.setOpacity(i)}if(this._currentLayer&&this._currentLayer.setOpacity){this._currentLayer.setOpacity(i)}return this},bringToBack:function(){if(!this._currentLayer){return}this._currentLayer.bringToBack();return this},bringToFront:function(){if(!this._currentLayer){return}this._currentLayer.bringToFront();return this},_onNewTimeLoading:function(i){this.fire("timeload",{time:i.time});return},isReady:function(i){return true},_update:function(){return true},getBaseLayer:function(){return this._baseLayer},getBounds:function(){var i=new L.LatLngBounds;if(this._currentLayer){i.extend(this._currentLayer.getBounds?this._currentLayer.getBounds():this._currentLayer.getLatLng())}return i}});L.timeDimension.layer=function(i,e){return new L.TimeDimension.Layer(i,e)};L.TimeDimension.Layer.GeoJson=L.TimeDimension.Layer.extend({initialize:function(i,e){L.TimeDimension.Layer.prototype.initialize.call(this,i,e);this._updateTimeDimension=this.options.updateTimeDimension||false;this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||"extremes";this._duration=this.options.duration||null;this._addlastPoint=this.options.addlastPoint||false;this._waitForReady=this.options.waitForReady||false;this._defaultTime=0;this._availableTimes=[];this._loaded=false;if(this._baseLayer.getLayers().length==0){if(this._waitForReady){this._baseLayer.on("ready",this._onReadyBaseLayer,this)}else{this._loaded=true}}else{this._loaded=true;this._setAvailableTimes()}this._baseLayer.on("layeradd",function(){if(this._loaded){this._setAvailableTimes()}}.bind(this))},onAdd:function(i){L.TimeDimension.Layer.prototype.onAdd.call(this,i);if(this._loaded){this._setAvailableTimes()}},eachLayer:function(i,e){if(this._currentLayer){i.call(e,this._currentLayer)}return L.TimeDimension.Layer.prototype.eachLayer.call(this,i,e)},isReady:function(i){return this._loaded},_update:function(){if(!this._map)return;if(!this._loaded){return}var i=this._timeDimension.getCurrentTime();var e=this._timeDimension.getCurrentTime(),t=0;if(this._duration){var s=new Date(e);L.TimeDimension.Util.subtractTimeDuration(s,this._duration,true);t=s.getTime()}var n=L.geoJson(null,this._baseLayer.options);var a=this._baseLayer.getLayers();for(var o=0,r=a.length;o<r;o++){var l=this._getFeatureBetweenDates(a[o].feature,t,e);if(l){n.addData(l);if(this._addlastPoint&&l.geometry.type=="LineString"){if(l.geometry.coordinates.length>0){var h=l.properties;h.last=true;n.addData({type:"Feature",properties:h,geometry:{type:"Point",coordinates:l.geometry.coordinates[l.geometry.coordinates.length-1]}})}}}}if(this._currentLayer){this._map.removeLayer(this._currentLayer)}if(n.getLayers().length){n.addTo(this._map);this._currentLayer=n}},_setAvailableTimes:function(){var i=[];this._availableTimes=[];var e=this._baseLayer.getLayers();for(var t=0,s=e.length;t<s;t++){if(e[t].feature){i=L.TimeDimension.Util.union_arrays(i,this._getFeatureTimes(e[t].feature))}}for(var t=0,s=i.length;t<s;t++){var n=i[t];if(typeof n=="string"||n instanceof String){n=Date.parse(n.trim())}this._availableTimes.push(n)}if(this._timeDimension&&(this._updateTimeDimension||this._timeDimension.getAvailableTimes().length==0)){this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode)}},_getFeatureTimes:function(i){if(!i.properties){return[]}if(i.properties.hasOwnProperty("coordTimes")){return i.properties.coordTimes}if(i.properties.hasOwnProperty("times")){return i.properties.times}if(i.properties.hasOwnProperty("linestringTimestamps")){return i.properties.linestringTimestamps}if(i.properties.hasOwnProperty("time")){return[i.properties.time]}return[]},_getFeatureBetweenDates:function(i,e,t){var s=this._getFeatureTimes(i);if(s.length==0){return i}var n=[];for(var a=0,o=s.length;a<o;a++){var r=s[a];if(typeof r=="string"||r instanceof String){r=Date.parse(r.trim())}n.push(r)}if(n[0]>t||n[o-1]<e){return null}var l=null,h=null,o=n.length;if(n[o-1]>e){for(var a=0;a<o;a++){if(l===null&&n[a]>e){l=a}if(n[a]>t){h=a;break}}}if(l===null){l=0}if(h===null){h=o}var m=[];if(i.geometry.coordinates[0].length){m=i.geometry.coordinates.slice(l,h)}else{m=i.geometry.coordinates}return{type:"Feature",properties:i.properties,geometry:{type:i.geometry.type,coordinates:m}}},_onReadyBaseLayer:function(){this._loaded=true;this._setAvailableTimes();this._update()}});L.timeDimension.layer.geoJson=function(i,e){return new L.TimeDimension.Layer.GeoJson(i,e)};L.TimeDimension.Player=(L.Layer||L.Class).extend({includes:L.Mixin.Events,initialize:function(i,e){L.setOptions(this,i);this._timeDimension=e;this._paused=false;this._buffer=this.options.buffer||5;this._minBufferReady=this.options.minBufferReady||1;this._waitingForBuffer=false;this._loop=this.options.loop||false;this._steps=1;this._timeDimension.on("timeload",function(i){this.release();this._waitingForBuffer=false}.bind(this));this.setTransitionTime(this.options.transitionTime||1e3)},_tick:function(){var i=this._getMaxIndex();var e=this._timeDimension.getCurrentTimeIndex()>=i&&this._steps>0;var t=this._timeDimension.getCurrentTimeIndex()==0&&this._steps<0;if(e||t){if(!this._loop){this.pause();this.stop();this.fire("animationfinished");return}}if(this._paused){return}var s=0,n=this._bufferSize;if(this._minBufferReady>0){s=this._timeDimension.getNumberNextTimesReady(this._steps,n,this._loop);if(this._waitingForBuffer){if(s<n){console.log("Waiting until buffer is loaded. "+s+" of "+n+" loaded");this.fire("waiting",{buffer:n,available:s});return}else{console.log("Buffer is fully loaded!");this.fire("running");this._waitingForBuffer=false}}else{if(s<this._minBufferReady){console.log("Force wait for load buffer. "+s+" of "+n+" loaded");this._waitingForBuffer=true;this._timeDimension.prepareNextTimes(this._steps,n,this._loop);this.fire("waiting",{buffer:n,available:s});return}}}this.pause();this._timeDimension.nextTime(this._steps,this._loop);if(n>0){this._timeDimension.prepareNextTimes(this._steps,n,this._loop)}},_getMaxIndex:function(){return Math.min(this._timeDimension.getAvailableTimes().length-1,this._timeDimension.getUpperLimitIndex()||Infinity)},start:function(i){if(this._intervalID)return;this._steps=i||1;this._waitingForBuffer=false;if(this.options.startOver){if(this._timeDimension.getCurrentTimeIndex()===this._getMaxIndex()){this._timeDimension.setCurrentTimeIndex(this._timeDimension.getLowerLimitIndex()||0)}}this.release();this._intervalID=window.setInterval(L.bind(this._tick,this),this._transitionTime);this._tick();this.fire("play");this.fire("running")},stop:function(){if(!this._intervalID)return;clearInterval(this._intervalID);this._intervalID=null;this.fire("stop")},pause:function(){this._paused=true},release:function(){this._paused=false},getTransitionTime:function(){return this._transitionTime},isPlaying:function(){return this._intervalID?true:false},isWaiting:function(){return this._waitingForBuffer},isLooped:function(){return this._loop},setLooped:function(i){this._loop=i;this.fire("loopchange",{loop:i})},setTransitionTime:function(i){this._transitionTime=i;if(typeof this._buffer==="function"){this._bufferSize=this._buffer.call(this,this._transitionTime,this._minBufferReady,this._loop);console.log("Buffer size changed to "+this._bufferSize)}else{this._bufferSize=this._buffer}if(this._intervalID){this.stop();this.start()}this.fire("speedchange",{transitionTime:i,buffer:this._bufferSize})},getSteps:function(){return this._steps}});L.TimeDimension.Util={getTimeDuration:function(i){if(nezasa===undefined){throw"iso8601-js-period library is required for Leatlet.TimeDimension: https://github.com/nezasa/iso8601-js-period"}return nezasa.iso8601.Period.parse(i,true)},addTimeDuration:function(i,e,t){if(t===undefined){t=true}if(typeof e=="string"||e instanceof String){e=this.getTimeDuration(e)}var s=e.length;var n=t?"getUTC":"get";var a=t?"setUTC":"set";if(s>0&&e[0]!=0){i[a+"FullYear"](i[n+"FullYear"]()+e[0])}if(s>1&&e[1]!=0){i[a+"Month"](i[n+"Month"]()+e[1])}if(s>2&&e[2]!=0){i[a+"Date"](i[n+"Date"]()+e[2]*7)}if(s>3&&e[3]!=0){i[a+"Date"](i[n+"Date"]()+e[3])}if(s>4&&e[4]!=0){i[a+"Hours"](i[n+"Hours"]()+e[4])}if(s>5&&e[5]!=0){i[a+"Minutes"](i[n+"Minutes"]()+e[5])}if(s>6&&e[6]!=0){i[a+"Seconds"](i[n+"Seconds"]()+e[6])}},subtractTimeDuration:function(i,e,t){if(typeof e=="string"||e instanceof String){e=this.getTimeDuration(e)}var s=[];for(var n=0,a=e.length;n<a;n++){s.push(-e[n])}this.addTimeDuration(i,s,t)},parseAndExplodeTimeRange:function(i){var e=i.split("/");var t=new Date(Date.parse(e[0]));var s=new Date(Date.parse(e[1]));var n=e.length>2?e[2]:"P1D";return this.explodeTimeRange(t,s,n)},explodeTimeRange:function(i,e,t,s){var n=this.getTimeDuration(t);var a=[];var o=new Date(i.getTime());var r=null,l=null,h=null,m=null;if(s!==undefined){var u=s.split("/");r=u[0].split(":")[0];l=u[0].split(":")[1];h=u[1].split(":")[0];m=u[1].split(":")[1]}while(o<e){if(s===undefined||o.getUTCHours()>=r&&o.getUTCHours()<=h){if((o.getUTCHours()!=r||o.getUTCMinutes()>=l)&&(o.getUTCHours()!=h||o.getUTCMinutes()<=m)){a.push(o.getTime())}}this.addTimeDuration(o,n)}if(o>=e){a.push(e.getTime())}return a},parseTimeInterval:function(i){var e=i.split("/");if(e.length!=2){throw"Incorrect ISO9601 TimeInterval: "+i}var t=Date.parse(e[0]);var s=null;var n=null;if(isNaN(t)){n=this.getTimeDuration(e[0]);s=Date.parse(e[1]);t=new Date(s);this.subtractTimeDuration(t,n,true);s=new Date(s)}else{s=Date.parse(e[1]);if(isNaN(s)){n=this.getTimeDuration(e[1]);s=new Date(t);this.addTimeDuration(s,n,true)}else{s=new Date(s)}t=new Date(t)}return[t,s]},parseTimesExpression:function(i){var e=[];if(!i){return e}if(typeof i=="string"||i instanceof String){var t=i.split(",");var s;var n;for(var a=0,o=t.length;a<o;a++){s=t[a];if(s.split("/").length==3){e=e.concat(this.parseAndExplodeTimeRange(s))}else{n=Date.parse(s);if(!isNaN(n)){e.push(n)}}}}else{e=i}return e.sort(function(i,e){return i-e})},intersect_arrays:function(i,e){var t=i.slice(0);var s=e.slice(0);var n=[];while(t.length>0&&s.length>0){if(t[0]<s[0]){t.shift()}else if(t[0]>s[0]){s.shift()}else{n.push(t.shift());s.shift()}}return n},union_arrays:function(i,e){var t=i.slice(0);var s=e.slice(0);var n=[];while(t.length>0&&s.length>0){if(t[0]<s[0]){n.push(t.shift())}else if(t[0]>s[0]){n.push(s.shift())}else{n.push(t.shift());s.shift()}}if(t.length>0){n=n.concat(t)}else if(s.length>0){n=n.concat(s)}return n}};L.UI=L.ui=L.UI||{};L.UI.Knob=L.Draggable.extend({options:{className:"knob",step:1,rangeMin:0,rangeMax:10},initialize:function(i,e){L.setOptions(this,e);this._element=L.DomUtil.create("div",this.options.className||"knob",i);L.Draggable.prototype.initialize.call(this,this._element,this._element);this._container=i;this.on("predrag",function(){this._newPos.y=0;this._newPos.x=this._adjustX(this._newPos.x)},this);this.on("dragstart",function(){L.DomUtil.addClass(i,"dragging")});this.on("dragend",function(){L.DomUtil.removeClass(i,"dragging")});L.DomEvent.on(this._element,"dblclick",function(i){this.fire("dblclick",i)},this);L.DomEvent.disableClickPropagation(this._element);this.enable()},_getProjectionCoef:function(){return(this.options.rangeMax-this.options.rangeMin)/(this._container.offsetWidth||this._container.style.width)},_update:function(){this.setPosition(L.DomUtil.getPosition(this._element).x)},_adjustX:function(i){var e=this._toValue(i)||this.getMinValue();return this._toX(this._adjustValue(e))},_adjustValue:function(i){i=Math.max(this.getMinValue(),Math.min(this.getMaxValue(),i));i=i-this.options.rangeMin;i=Math.round(i/this.options.step)*this.options.step;i=i+this.options.rangeMin;i=Math.round(i*100)/100;return i},_toX:function(i){var e=(i-this.options.rangeMin)/this._getProjectionCoef();return e},_toValue:function(i){var e=i*this._getProjectionCoef()+this.options.rangeMin;return e},getMinValue:function(){return this.options.minValue||this.options.rangeMin},getMaxValue:function(){return this.options.maxValue||this.options.rangeMax},setStep:function(i){this.options.step=i;this._update()},setPosition:function(i){L.DomUtil.setPosition(this._element,L.point(this._adjustX(i),0));this.fire("positionchanged")},getPosition:function(){return L.DomUtil.getPosition(this._element).x},setValue:function(i){this.setPosition(this._toX(i))},getValue:function(){return this._adjustValue(this._toValue(this.getPosition()))}});L.Control.TimeDimension=L.Control.extend({options:{styleNS:"leaflet-control-timecontrol",position:"bottomleft",title:"Time Control",backwardButton:true,forwardButton:true,playButton:true,playReverseButton:false,loopButton:false,displayDate:true,timeSlider:true,timeSliderDragUpdate:false,limitSliders:false,limitMinimumRange:5,speedSlider:true,minSpeed:.1,maxSpeed:10,speedStep:.1,timeSteps:1,autoPlay:false,playerOptions:{transitionTime:1e3}},initialize:function(i){L.Control.prototype.initialize.call(this,i);this._dateUTC=true;this._timeDimension=this.options.timeDimension||null},onAdd:function(i){var e;this._map=i;if(!this._timeDimension&&i.timeDimension){this._timeDimension=i.timeDimension}this._initPlayer();e=L.DomUtil.create("div","leaflet-bar leaflet-bar-horizontal leaflet-bar-timecontrol");if(this.options.backwardButton){this._buttonBackward=this._createButton("Backward",e)}if(this.options.playReverseButton){this._buttonPlayReversePause=this._createButton("Play Reverse",e)}if(this.options.playButton){this._buttonPlayPause=this._createButton("Play",e)}if(this.options.forwardButton){this._buttonForward=this._createButton("Forward",e)}if(this.options.loopButton){this._buttonLoop=this._createButton("Loop",e)}if(this.options.displayDate){this._displayDate=this._createDisplayDate(this.options.styleNS+" timecontrol-date",e)}if(this.options.timeSlider){this._sliderTime=this._createSliderTime(this.options.styleNS+" timecontrol-slider timecontrol-dateslider",e)}if(this.options.speedSlider){this._sliderSpeed=this._createSliderSpeed(this.options.styleNS+" timecontrol-slider timecontrol-speed",e)}this._steps=this.options.timeSteps||1;this._timeDimension.on("timeload",this._update,this);this._timeDimension.on("timeload",this._onPlayerStateChange,this);this._timeDimension.on("timeloading",this._onTimeLoading,this);this._timeDimension.on("limitschanged availabletimeschanged",this._onTimeLimitsChanged,this);L.DomEvent.disableClickPropagation(e);return e},addTo:function(){L.Control.prototype.addTo.apply(this,arguments);this._onPlayerStateChange();this._onTimeLimitsChanged();this._update();return this},onRemove:function(){this._player.off("play stop running loopchange speedchange",this._onPlayerStateChange,this);this._player.off("waiting",this._onPlayerWaiting,this);this._timeDimension.off("timeload",this._update,this);this._timeDimension.off("timeload",this._onPlayerStateChange,this);this._timeDimension.off("timeloading",this._onTimeLoading,this);this._timeDimension.off("limitschanged availabletimeschanged",this._onTimeLimitsChanged,this)},_initPlayer:function(){if(!this._player){if(this.options.player){this._player=this.options.player}else{this._player=new L.TimeDimension.Player(this.options.playerOptions,this._timeDimension)}}if(this.options.autoPlay){this._player.start(this._steps)}this._player.on("play stop running loopchange speedchange",this._onPlayerStateChange,this);this._player.on("waiting",this._onPlayerWaiting,this);this._onPlayerStateChange()},_onTimeLoading:function(i){if(i.time==this._timeDimension.getCurrentTime()){if(this._displayDate){L.DomUtil.addClass(this._displayDate,"loading")}}},_onTimeLimitsChanged:function(){var i=this._timeDimension.getLowerLimitIndex(),e=this._timeDimension.getUpperLimitIndex(),t=this._timeDimension.getAvailableTimes().length-1;if(this._limitKnobs){this._limitKnobs[0].options.rangeMax=t;this._limitKnobs[1].options.rangeMax=t;this._limitKnobs[0].setValue(i||0);this._limitKnobs[1].setValue(e||t)}if(this._sliderTime){this._sliderTime.options.rangeMax=t;this._sliderTime._update()}},_onPlayerWaiting:function(i){if(this._buttonPlayPause&&this._player.getSteps()>0){L.DomUtil.addClass(this._buttonPlayPause,"loading");this._buttonPlayPause.innerHTML=this._getDisplayLoadingText(i.available,i.buffer)}if(this._buttonPlayReversePause&&this._player.getSteps()<0){L.DomUtil.addClass(this._buttonPlayReversePause,"loading");this._buttonPlayReversePause.innerHTML=this._getDisplayLoadingText(i.available,i.buffer)}},_onPlayerStateChange:function(){if(this._buttonPlayPause){if(this._player.isPlaying()&&this._player.getSteps()>0){L.DomUtil.addClass(this._buttonPlayPause,"pause");L.DomUtil.removeClass(this._buttonPlayPause,"play")}else{L.DomUtil.removeClass(this._buttonPlayPause,"pause");L.DomUtil.addClass(this._buttonPlayPause,"play")}if(this._player.isWaiting()&&this._player.getSteps()>0){L.DomUtil.addClass(this._buttonPlayPause,"loading")}else{this._buttonPlayPause.innerHTML="";L.DomUtil.removeClass(this._buttonPlayPause,"loading")}}if(this._buttonPlayReversePause){if(this._player.isPlaying()&&this._player.getSteps()<0){L.DomUtil.addClass(this._buttonPlayReversePause,"pause")}else{L.DomUtil.removeClass(this._buttonPlayReversePause,"pause")}if(this._player.isWaiting()&&this._player.getSteps()<0){L.DomUtil.addClass(this._buttonPlayReversePause,"loading")}else{this._buttonPlayReversePause.innerHTML="";L.DomUtil.removeClass(this._buttonPlayReversePause,"loading")}}if(this._buttonLoop){if(this._player.isLooped()){L.DomUtil.addClass(this._buttonLoop,"looped")}else{L.DomUtil.removeClass(this._buttonLoop,"looped")}}if(this._sliderSpeed&&!this._draggingSpeed){var i=this._player.getTransitionTime()||1e3;i=Math.round(1e4/i)/10;this._sliderSpeed.setValue(i)}},_update:function(){if(!this._timeDimension){return}if(this._timeDimension.getCurrentTimeIndex()>=0){var i=new Date(this._timeDimension.getCurrentTime());if(this._displayDate){L.DomUtil.removeClass(this._displayDate,"loading");this._displayDate.innerHTML=this._getDisplayDateFormat(i)}if(this._sliderTime&&!this._slidingTimeSlider){this._sliderTime.setValue(this._timeDimension.getCurrentTimeIndex())}}else{if(this._displayDate){this._displayDate.innerHTML=this._getDisplayNoTimeError()}}},_createButton:function(i,e){var t=L.DomUtil.create("a",this.options.styleNS+" timecontrol-"+i.toLowerCase(),e);t.href="#";t.title=i;L.DomEvent.addListener(t,"click",L.DomEvent.stopPropagation).addListener(t,"click",L.DomEvent.preventDefault).addListener(t,"click",this["_button"+i.replace(/ /i,"")+"Clicked"],this);return t},_createDisplayDate:function(i,e){var t=L.DomUtil.create("a",i+" utc",e);t.href="#";t.title="UTC Time";L.DomEvent.addListener(t,"click",L.DomEvent.stopPropagation).addListener(t,"click",L.DomEvent.preventDefault).addListener(t,"click",this._toggleDateUTC,this);return t},_createSliderTime:function(i,e){var t,s,n,a,o;t=L.DomUtil.create("div",i,e);s=L.DomUtil.create("div","slider",t);n=this._timeDimension.getAvailableTimes().length-1;if(this.options.limitSliders){o=this._limitKnobs=this._createLimitKnobs(s)}a=new L.UI.Knob(s,{className:"knob main",rangeMin:0,rangeMax:n});a.on("dragend",function(i){var e=i.target.getValue();this._sliderTimeValueChanged(e);this._slidingTimeSlider=false},this);a.on("drag",function(i){this._slidingTimeSlider=true;var e=this._timeDimension.getAvailableTimes()[i.target.getValue()];if(e){var t=new Date(e);if(this._displayDate){this._displayDate.innerHTML=this._getDisplayDateFormat(t)}if(this.options.timeSliderDragUpdate){this._sliderTimeValueChanged(i.target.getValue())}}},this);a.on("predrag",function(){var i,e;if(o){i=o[0].getPosition();e=o[1].getPosition();if(this._newPos.x<i){this._newPos.x=i}if(this._newPos.x>e){this._newPos.x=e}}},a);L.DomEvent.on(s,"click",function(i){if(L.DomUtil.hasClass(i.target,"knob")){return}var e=i.touches&&i.touches.length===1?i.touches[0]:i,t=L.DomEvent.getMousePosition(e,s).x;if(o){if(o[0].getPosition()<=t&&t<=o[1].getPosition()){a.setPosition(t);this._sliderTimeValueChanged(a.getValue())}}else{a.setPosition(t);this._sliderTimeValueChanged(a.getValue())}},this);a.setPosition(0);return a},_createLimitKnobs:function(i){L.DomUtil.addClass(i,"has-limits");var e=this._timeDimension.getAvailableTimes().length-1;var t=L.DomUtil.create("div","range",i);var s=new L.UI.Knob(i,{className:"knob lower",rangeMin:0,rangeMax:e});var n=new L.UI.Knob(i,{className:"knob upper",rangeMin:0,rangeMax:e});L.DomUtil.setPosition(t,0);s.setPosition(0);n.setPosition(e);s.on("dragend",function(i){var e=i.target.getValue();this._sliderLimitsValueChanged(e,n.getValue())},this);n.on("dragend",function(i){var e=i.target.getValue();this._sliderLimitsValueChanged(s.getValue(),e)},this);s.on("drag positionchanged",function(){L.DomUtil.setPosition(t,L.point(s.getPosition(),0));t.style.width=n.getPosition()-s.getPosition()+"px"},this);n.on("drag positionchanged",function(){t.style.width=n.getPosition()-s.getPosition()+"px"},this);n.on("predrag",function(){var i=s._toX(s.getValue()+this.options.limitMinimumRange);if(n._newPos.x<=i){n._newPos.x=i}},this);s.on("predrag",function(){var i=n._toX(n.getValue()-this.options.limitMinimumRange);if(s._newPos.x>=i){s._newPos.x=i}},this);s.on("dblclick",function(){this._timeDimension.setLowerLimitIndex(0)},this);n.on("dblclick",function(){this._timeDimension.setUpperLimitIndex(this._timeDimension.getAvailableTimes().length-1)},this);return[s,n]},_createSliderSpeed:function(i,e){var t=L.DomUtil.create("div",i,e);var s=L.DomUtil.create("span","speed",t);var n=L.DomUtil.create("div","slider",t);var a=Math.round(1e4/(this._player.getTransitionTime()||1e3))/10;s.innerHTML=this._getDisplaySpeed(a);var o=new L.UI.Knob(n,{step:this.options.speedStep,rangeMin:this.options.minSpeed,rangeMax:this.options.maxSpeed});o.on("dragend",function(i){var e=i.target.getValue();this._draggingSpeed=false;s.innerHTML=this._getDisplaySpeed(e);this._sliderSpeedValueChanged(e)},this);o.on("drag",function(i){this._draggingSpeed=true;s.innerHTML=this._getDisplaySpeed(i.target.getValue())},this);o.on("positionchanged",function(i){s.innerHTML=this._getDisplaySpeed(i.target.getValue())},this);L.DomEvent.on(n,"click",function(i){if(i.target===o._element){return}var e=i.touches&&i.touches.length===1?i.touches[0]:i,t=L.DomEvent.getMousePosition(e,n).x;o.setPosition(t);s.innerHTML=this._getDisplaySpeed(o.getValue());this._sliderSpeedValueChanged(o.getValue())},this);return o},_buttonBackwardClicked:function(){this._timeDimension.previousTime(this._steps)},_buttonForwardClicked:function(){this._timeDimension.nextTime(this._steps)},_buttonLoopClicked:function(){this._player.setLooped(!this._player.isLooped())},_buttonPlayClicked:function(){if(this._player.isPlaying()){if(this._player.isWaiting()){this._player.stop();this._player.start(this._steps)}else{this._player.stop()}}else{this._player.start(this._steps)}},_buttonPlayReverseClicked:function(){if(this._player.isPlaying()){if(this._player.isWaiting()){this._player.stop();this._player.start(this._steps*-1)}else{this._player.stop()}}else{this._player.start(this._steps*-1)}},_sliderTimeValueChanged:function(i){this._timeDimension.setCurrentTimeIndex(i)},_sliderLimitsValueChanged:function(i,e){this._timeDimension.setLowerLimitIndex(i);this._timeDimension.setUpperLimitIndex(e)},_sliderSpeedValueChanged:function(i){this._player.setTransitionTime(1e3/i)},_toggleDateUTC:function(){if(this._dateUTC){L.DomUtil.removeClass(this._displayDate,"utc");this._displayDate.title="Local Time"}else{L.DomUtil.addClass(this._displayDate,"utc");this._displayDate.title="UTC Time"}this._dateUTC=!this._dateUTC;this._update()},_getDisplayDateFormat:function(i){return this._dateUTC?i.toISOString():i.toLocaleString()},_getDisplaySpeed:function(i){return i+"fps"},_getDisplayLoadingText:function(i,e){return"<span>"+Math.floor(i/e*100)+"%</span>"},_getDisplayNoTimeError:function(){return"Time not available"}});L.Map.addInitHook(function(){if(this.options.timeDimensionControl){this.timeDimensionControl=L.control.timeDimension(this.options.timeDimensionControlOptions||{});this.addControl(this.timeDimensionControl)}});L.control.timeDimension=function(i){return new L.Control.TimeDimension(i)};