<html>
    <head>
	<title>HYSPLIT Viewer - xCITE Data Lab</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- leaflet stuff -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css" integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw==" crossorigin="">
	<script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js" integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA==" crossorigin=""></script>
	<!-- topojson stuff -->
	<script src="https://unpkg.com/topojson@3"></script>
	<!-- jquery stuff -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js"></script>
	<!-- slider stuff -->
	<script src="js/leaflet-slider.js"></script>
	<link rel="stylesheet" href="css/leaflet-slider.css">
	<!-- hysplit app files -->
	<script src="js/hysplit.js"></script>
	<link rel="stylesheet" href="css/hysplit.css">
    </head>
    <body>
	<div id="map"></div>
	<script type="text/javascript">

	 /* useful global variables */
	 /* contour levels */
	 var levels = [-2, -1, 0, 1, 2, 3, 4, 5];
	 /* object containing contour geometries (for caching) */
	 var geoms = {};
	 /* default site */
	 var starting_site = 'BUFF';

	 /* first set up the non-changing stuff: */
	 var contour_layers = L.layerGroup([]);
	 var traj_layers = L.layerGroup([]);
	 var map = L.map('map0', {layers: [contour_layers, traj_layers]}).setView([43, -74.5], 7);

	 L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
	     maxZoom: 18,
	     attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			  '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			  'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
	     id: 'mapbox.light'
	 }).addTo(map);

	 // get color depending on population density value
	 function getColor(d) {
	     return d >= 5  ? '#800000' :
		    d >= 4  ? '#ff3200' :
		    d >= 3  ? '#ffb900' :
		    d >= 2  ? '#b6ff41' :
		    d >= 1  ? '#41ffb6' :
		    d >= 0  ? '#00a4ff' :
		    d >= -1 ? '#0012ff' :
		    '#000080';
	 };

	 /* legend */
	 var legend = L.control({position: 'bottomright'});
	 legend.onAdd = function (map) {
	     var div = L.DomUtil.create('div', 'info legend'),
		 /* grades = [0, 10, 20, 50, 100, 200, 500, 1000],*/
	     grades = levels,
		 labels = [],
		 from, to;
	     var legend_title = '<h4>PM Levels</h4>'
	     for (var i = grades.length - 1; i >= 0; i--) {
		 from = grades[i];
		 to = grades[i + 1];
		 labels.push(
		     '<span id="ng' + from + '"><i style="background:' + getColor(from) + '"></i> <b>' +
		     '10<sup>' + from + '</sup>' +
																																			     (i + 1 < grades.length ? '&ndash;10<sup>' + to + '</sup>' : '+') + '</b> ng/m<sup>3</sup></span>');
	     }
	     div.innerHTML = legend_title + labels.join('<br>');
	     return div;
	 };
	 legend.addTo(map);

	 /* site marker functions */
	 function highlightSiteMarker(e) {
	     var marker = e.target;
	     marker.setStyle({
		 radius: 7,
		 weight: 2,
		 fillOpacity: .6
	     });
	     site_info.update(marker['site_name']);
	 }

	 /* 'store' locator */
	 var site_map;
	 var locator = L.control({position: 'topright'});
	 locator.onAdd = function (map) {
	     var div = L.DomUtil.create('div', 'info');
	     var site_div = document.createElement("div");
	     site_div.id = 'locator';
	     div.appendChild(site_div);
	     /* var legend_title = '<h4>PM Levels</h4>'
		for (var i = grades.length - 1; i >= 0; i--) {
		from = grades[i];
		to = grades[i + 1];
		labels.push(
		'<i style="background:' + getColor(from) + '"></i> <b>' +
		'10<sup>' + from + '</sup>' +
		(i + 1 < grades.length ? '&ndash;10<sup>' + to + '</sup>' : '+') + '</b> ng/m<sup>3</sup>');
		}
		div.innerHTML = legend_title + labels.join('<br>');*/
	     return div;
	 };
	 locator.addTo(map);
	 locator.update = function (site) {
	     /* this._container.firstChild.nodeValue = site;*/
	 };

	 site_map_options = {zoomControl: false,
			     attributionControl: false}
	 site_map = L.map('locator', site_map_options).setView([43, -76], 6);
	 L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2tlcHRpa29zIiwiYSI6ImNqNWU2NjNhYzAwcDEycWpqdTJtNWJmNGYifQ.kxK-j2hWsX46EhH5PnsTfA', {
	     maxZoom: 18,
	     id: 'mapbox.streets'
	 }).addTo(site_map);

	 /* get the site locations */
	 /* using https://github.com/evanplaice/jquery-csv/ */
	 var sites;
	 /* circleMarker options */
	 var cm_options;
	 var cm_red_options;
	 var cm_orig_options;
	 cm_options = {radius: 7, color: '#333',
		       weight: 2, opacity: .6,
		       fillOpacity: .2};
	 cm_red_options = {radius: 7, color: 'red',
			   weight: 2, opacity: .6};
	 cm_orig_options = {radius: 5, color: '#ff9000',
			    weight: 2, fillOpacity: .6};
	 /* var circle_markers = [];*/
	 var origin_circle;
	 var sites_layer;
	 $.get('data/nysm.csv', function(csv) {
	     sites_layer = L.featureGroup();
	     sites = $.csv.toObjects(csv);
	     $.each(sites, function(i, site) {
		 var lat = parseFloat(site['lat [degrees]']);
		 var lon = parseFloat(site['lon [degrees]']);
		 var this_marker;
		 if (site['stid'] == starting_site) {
		     this_options = cm_red_options;
		     map['origin_circle'] = L.circleMarker([lat, lon], cm_orig_options);
		     map['origin_circle'].addTo(map);
		 } else {
		     this_options = cm_options;
		 }
		 this_marker = L.circleMarker([lat, lon], this_options);
		 this_marker['site_name'] = site['stid'];
		 this_marker.on('mouseover', highlightSiteMarker);
		 this_marker.on('mouseout', function (e) {
		     this.setStyle(this_options);
		     site_info.update();
		 }, this_marker);
		 this_marker.on('click', function(e) {
		     /* update the contours */
		     changeSite(this['site_name'], true, geoms);
		     /* update the clicked marker */
		     this.setStyle(cm_red_options);
		     this.on('mouseout', function (e) {
			 this.setStyle(cm_red_options);
			 site_info.update();
		     });
		     /* update the previously selected marker */
		     site_map['selected_circle'].setStyle(cm_options);
		     /* make the clicked marker the new selected marker */
		     site_map['selected_circle'] = this;
		     /* update the map origin point */
		     var latlon = [this._latlng.lat, this._latlng.lng]
		     map['origin_circle'].remove();
		     map['origin_circle'] = L.circleMarker(latlon, cm_orig_options);
		     map['origin_circle'].addTo(map);
		     /* update the current site name */
		     $('#cur_site')[0].innerHTML = this['site_name'];
		 });
		 sites_layer.addLayer(this_marker);
		 if (this_marker['site_name'] == starting_site) {
		     site_map['selected_circle'] = this_marker;
		 }
	     });
	     
	     sites_layer.addTo(site_map);
	 }, 'text');

	 /* site info box in the site locator map */
	 var site_info = L.control({position: 'topleft'});
	 site_info.onAdd = function (map) {
	     this._div = L.DomUtil.create('div', 'info');
	     this._div.innerHTML = '<h4>Current Site: <span id="cur_site">' +
				   starting_site + '</span></h4>' +
				   'Switch to: <span id="hov_site"></span>';
	     this.update();
	     return this._div;
	 };
	 site_info.update = function (props) {
	     try {
		 $('#hov_site')[0].innerHTML = (props ? props : '');
	     } catch(err) {};
	 };
	 site_info.addTo(site_map);


	 /* now all the changing stuff: */

	 function style(feature) {
	     return {
		 weight: 0,
		 opacity: 1,
		 color: 'white',
		 fillOpacity: 0.5,
		 fillColor: getColor(feature.properties.level)
	     };
	 }

	 function trStyle(feature) {
	     return {
		 weight: 3,
		 opacity: .6,
		 color: '#5075DB'
	     };
	 }

	 function highlightFeature(e) {
	     var contour = e.target;
	     tooltip_options = {sticky: true}
	     tooltip = L.tooltip(tooltip_options);
	     contour.bindTooltip(tooltip).openTooltip();
	     contour.setTooltipContent(contour.feature.properties.level_name);
	 }

	 function resetHighlight(e) {
	     /* pm_layer.resetStyle(e.target);*/
	     /* info.update();*/
	 }

	 function zoomToFeature(e) {
	     map.fitBounds(e.target.getBounds());
	 }

	 function onEachFeature(feature, layer) {
	     layer.on({
		 mouseover: highlightFeature,
		 mouseout: resetHighlight,
		 click: zoomToFeature
	     });
	 }

	 /* change displayed data */
	 function chooseData(time, height, fwd, site, geoms) {
	     /* use topojson? */
	     var topojson = true;
	     
	     /* see if we can get cached data */
	     var cached = true;
	     /* need to get time and height indices as opposed to
		values */
	     if ($.inArray(site, Object.keys(geoms)) == -1) {
		 geoms[site] = {};
	     }
	     if ($.inArray(fwd, Object.keys(geoms[site])) == -1) {
		 geoms[site][fwd] = {};
	     }
	     site_geoms = geoms[site][fwd];
	     if ($.inArray(time, Object.keys(site_geoms)) == -1) {
		 site_geoms[time] = {};
	     }
	     if ($.inArray(height, Object.keys(site_geoms[time])) == -1) {
		 cached = false;
	     }

	     if (cached) {
		 contour_layers.clearLayers();
		 contour_layers.addLayer(site_geoms[time][height]);
	     } else {
		 if (fwd) {
		     fwd_folder = 'fwd/';
		 } else {
		     fwd_folder = 'bck/';
		 }
		 folder = 'data/' + site + '/' + fwd_folder;
		 file_path = folder + 'height' + height + '_time' + time + '.json';
		 $.getJSON(file_path, function(gjson) {
		     var pm_layer;
		     if (topojson) {
			 pm_layer = L.topoJson(gjson, {
			     style: style,
			     onEachFeature: onEachFeature,
			     smoothFactor: .5
			 });
		     } else {
			 pm_layer = L.geoJson(gjson.features, {
			     style: style,
			     onEachFeature: onEachFeature,
			     /* might need to be lowered due to inconsistent simplified contours */
			     smoothFactor: 1
			 });
		     };
		     contour_layers.clearLayers();
		     contour_layers.addLayer(pm_layer);
		     geoms[site][fwd][time][height] = pm_layer;
		 });
	     };
	 };

	 /* slider stuff */
	 create_time_slider = function(times, map) {
	     map['time_slider'] = L.control.slider(function(t) {changeTime(t);},
						   {id: 'time_slider', orientation: 'horizontal',
						    title: 'Select Hour', value: 0, min: 0,
						    max: times.length - 1, position: 'bottomleft',
						    logo: 'Time', size: '400px', collapsed: false,
						    getValue: function(time) {return times[time].toLocaleTimeString();},
						    syncSlider: true });
	     map['time_slider'].addTo(map);
	 };
	 create_heights_slider = function(heights, map) {
	     map['height_slider'] = L.control.slider(function(l) {changeHeight(l);},
						     {id: 'height_slider', orientation: 'vertical',
						      title: 'Select Height', value: 0,
						      max: heights.length - 1, position: 'bottomleft',
						      logo: 'Height', size: '100px', collapsed: false,
						      getValue: function(height) {return heights[height] + 'm';},
						      syncSlider: true });
	     map['height_slider'].addTo(map);
	 };
	 create_sliders = function(heights, times, map) {
	     create_time_slider(times, map);
	     create_heights_slider(heights, map);
	 };
	 remove_sliders = function(map) {
	     try {
		 map['time_slider'].remove();
	     } catch(err) {}
	     try {
		 map['height_slider'].remove();
	     } catch(err) {}
	 };
	 setup_sliders = function(heights, times, map) {
	     remove_sliders(map);
	     create_sliders(heights, times, map);
	 };


	 /* need to have a layer controller */
	 overlayMaps = {
	     'Contour': contour_layers,
	     'Trajectory': traj_layers
	 }
	 layerer = L.control.layers(null, overlayMaps, {position: 'topleft'}).addTo(map);
	 changeSite = function(site, fwd, geoms) {
	     var fwd_folder;
	     if (fwd) {
		 fwd_folder = 'fwd/';
	     } else {
		 fwd_folder = 'bck/';
	     }
	     var data_folder = 'data/' + site + '/' + fwd_folder;
	     var meta_file = data_folder + 'meta.json';
	     $.get(meta_file, function(json) {
		 /* a trajectory! */
		 /* try {
		    map['trajectory'].remove()
		    } catch(err) {}
		    try {
		    map['trajectory'] = L.geoJSON(json['trajectory'], {
		    style: trStyle,
		    smoothFactor: 1
		    }).addTo(map);
		    } catch (err) {}*/
		 
		 /* the available times and heights for the current site */
		 var times = json['times'].map(function(text) {return new Date(text)});
		 var heights = json['heights'];
		 var time = 0;
		 var height = 0;
		 /* add some utility functions that depend on times and heights */
		 changeTime = function(t) {
		     time = t;
		     var traj;
		     var tr2;
		     try {
			 tr2 = {'type': 'LineString'};
			 var line_coords = json['trajectory']['coordinates'];
			 if (fwd) {
			     tr2['coordinates'] = line_coords.slice(0, parseInt(t) + 2);		 
			 } else {
			     tr2['coordinates'] = line_coords.slice(0, line_coords.length - (parseInt(t))).reverse();
			 }
			 traj = L.geoJSON(tr2, {
			     style: trStyle,
			     smoothFactor: 1
			 });
			 traj_layers.clearLayers();
			 traj_layers.addLayer(traj);
		     } catch(err) {
			 traj_layers.clearLayers();
		     };
		     chooseData(time, height, fwd, site, geoms);
		 };
		 changeHeight = function(h) {
		     height = h;
		     chooseData(time, height, fwd, site, geoms);
		 };
		 function changeFwd(f) {
		     fwd = f;
		     chooseData(time, height, fwd, site, geoms);
		 };
		 function displayNextTime() {
		     if (time < times.length - 1) {
			 changeTime(which_time + 1);
		     } else {
			 changeTime(0);
		     }
		 };
		 /* set up the sliders */
		 setup_sliders(heights, times, map);
	     });
	 };

	 /* changeSite('BUFF', true, geoms);*/



	 /* simulation info box */
	 var sim_info = L.control({position: 'topright'});
	 sim_info.onAdd = function (map) {
	     this._div = L.DomUtil.create('div', 'info');
	     this.update();
	     return this._div;
	 };
	 sim_info.update = function (props) {
	     var custom_form;
	     this._div.innerHTML = '<h4>Simulation Info:</h4>' +
				   '<p>Release site: BUFF<br>' +
				   'Release time: 10am<br>' +
				   'More info about things, etc.</p>';
	     run_hysplit = function() {
		 var form = $("#hysplit");
		 var lat = form.find('input[name="lat"]').val();
		 var lon = form.find('input[name="lon"]').val();
		 /* Send the data using post with element id name and name2*/
		 var url = 'http://appsvr.asrc.cestm.albany.edu:5000?lat=' + lat + '&lon=' + lon;
		 $.post(url, callback=function(text) {
		     form.append('<p>Flask says:<br>' + text + '</p>');
		 });
	     };
	     custom_form = '<form id="hysplit" onSubmit="run_hysplit(); return false;">' +
			   'Latitude: <input type="text" name="lat"><br>' +
			   'Longitude: <input type="text" name="lon"><br>' +
			   '<input type="submit" value="Click me to run the model"></form>';
	     this._div.innerHTML += '<h4>Custom Simulation:</h4>' + custom_form;
	 };
	 sim_info.addTo(map);
	</script>
    </body>
</html>
